<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RR Inspo — Tiny Gallery with Tags</title>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px auto; max-width: 920px; padding: 0 12px; }
  header { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap: 12px; }
  .card { border: 1px solid #eee; padding: 8px; border-radius: 8px; background: #fff; }
  .card img { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; }
  .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .tag { font-size: 12px; padding: 3px 8px; border-radius: 999px; background: #f3f0f7; border: 1px dashed #d8cfe8; }
  .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
  input[type="file"] { max-width: 240px; }
  input[type="text"] { flex: 1; min-width: 180px; padding: 8px; }
  button { padding: 8px 12px; cursor: pointer; }
  .pill { padding: 6px 10px; border: 1px dashed #d8cfe8; border-radius: 999px; background: #faf7ff; }
</style>

<header>
  <h1>RR Inspo</h1>
  <span class="pill">upload → add tags → filter</span>
</header>

<section class="toolbar">
  <input id="file" type="file" accept="image/*" />
  <input id="tagsInput" type="text" placeholder="tags (comma or space separated)" />
  <button id="uploadBtn">Upload</button>
  <input id="filterInput" type="text" placeholder="filter by tag(s)… e.g. lace brown-pink" />
  <button id="clearBtn">Clear</button>
</section>

<section id="grid" class="grid"></section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://uxcgyjufibsaikpkdrxp.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4Y2d5anVmaWJzYWlrcGtkcnhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTQyNzMsImV4cCI6MjA3MzMzMDI3M30.kBdHEYIasQ_KZeMnRzDq68J1ihLBl1ZWue5QAgDfB8Y";
  const BUCKET = "photos";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const el = {
    file: document.getElementById('file'),
    tagsInput: document.getElementById('tagsInput'),
    uploadBtn: document.getElementById('uploadBtn'),
    filterInput: document.getElementById('filterInput'),
    clearBtn: document.getElementById('clearBtn'),
    grid: document.getElementById('grid')
  };

  let all = [];   // [{id,url,tags,created_at}, ...]
  let view = [];  // filtered

  function normalizeTags(str) {
    return (str || '')
      .split(/[,\s]+/).map(t => t.trim().toLowerCase()).filter(Boolean);
  }

  function render(items) {
    el.grid.innerHTML = items.map(item => `
      <article class="card">
        <img src="${item.url}" alt="" loading="lazy" />
        <div class="tags">${item.tags.map(t => `<span class="tag">#${t}</span>`).join('')}</div>
      </article>
    `).join('');
  }

  function applyFilter() {
    const terms = normalizeTags(el.filterInput.value);
    if (!terms.length) { view = all.slice(); return render(view); }
    view = all.filter(it => terms.every(t => it.tags.includes(t)));
    render(view);
  }

  async function loadAll() {
    const { data, error } = await sb.from('photos').select('*').order('created_at', { ascending: false });
    if (error) { console.error(error); return; }
    all = data || [];
    render(all);
  }

  el.filterInput.addEventListener('input', applyFilter);
  el.clearBtn.addEventListener('click', () => { el.filterInput.value=''; applyFilter(); });

  el.uploadBtn.addEventListener('click', async () => {
    const file = el.file.files?.[0];
    if (!file) return alert('Pick an image first');
    const tags = normalizeTags(el.tagsInput.value);

    // 1) upload to storage
    const ext = file.name.split('.').pop()?.toLowerCase() || 'jpg';
    const key = `${crypto.randomUUID()}.${ext}`;
    const { data: up, error: upErr } = await sb.storage.from(BUCKET).upload(key, file, { upsert: false });
    if (upErr) { alert('Upload error'); console.error(upErr); return; }

    // 2) get public URL
    const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(key);
    const url = pub?.publicUrl;

    // 3) insert row with tags
    const { data: row, error: insErr } = await sb.from('photos').insert({ url, tags }).select().single();
    if (insErr) { alert('Save error'); console.error(insErr); return; }

    // 4) reset UI & prepend
    el.file.value = '';
    el.tagsInput.value = '';
    all.unshift(row);
    applyFilter();
  });

  loadAll();
</script>
