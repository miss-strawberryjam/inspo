<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>rabbit reverie inspo — Tiny Gallery with Tags</title>

<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin:16px auto; max-width:920px; padding:0 12px; }
  header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; }
  .card { border:1px solid #eee; padding:8px; border-radius:8px; background:#fff; }
  .card img { width:100%; height:160px; object-fit:cover; border-radius:6px; }
  .tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
  .tag { font-size:12px; padding:3px 8px; border-radius:999px; background:#f3f0f7; border:1px dashed #d8cfe8; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
  input[type="file"] { max-width:240px; }
  input[type="text"] { flex:1; min-width:180px; padding:8px; }
  button { padding:8px 12px; cursor:pointer; }
  .pill { padding:6px 10px; border:1px dashed #d8cfe8; border-radius:999px; background:#faf7ff; }
</style>

<header>
  <h1>rabbit reverie inspo</h1>
  <span class="pill">upload → add tags → filter</span>
</header>

<section id="auth" style="margin:20px 0;">
  <h2>Sign in</h2>
  <input id="email" type="email" placeholder="email" />
  <input id="password" type="password" placeholder="password" />
  <button id="loginBtn">Log in</button>
  <button id="logoutBtn" style="display:none;">Log out</button>
</section>

<!-- Hide the whole gallery until logged in -->
<div id="gallery" style="display:none;">
  <section class="toolbar">
    <input id="file" type="file" accept="image/*" />
    <input id="tagsInput" type="text" placeholder="tags (comma or space separated)" />
    <input id="descInput" type="text" placeholder="description (optional)" />
    <button id="uploadBtn">Upload</button>
    <input id="filterInput" type="text" placeholder="filter by tag(s)… e.g. lace brown-pink" />
    <button id="clearBtn">Clear</button>

    <label style="display:flex;align-items:center;gap:6px;">
      <input id="mineOnly" type="checkbox"> Mine only
    </label>
    <input id="userIdFilter" type="text" placeholder="filter by user_id (optional)" />
  </section>

  <section id="grid" class="grid"></section>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


<script>
  // Supabase
  const SUPABASE_URL  = "https://uxcgyjufibsaikpkdrxp.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4Y2d5anVmaWJzYWlrcGtkcnhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTQyNzMsImV4cCI6MjA3MzMzMDI3M30.kBdHEYIasQ_KZeMnRzDq68J1ihLBl1ZWue5QAgDfB8Y";
  const BUCKET = "photos";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);


  // Auth UI
  const authEl = {
    email: document.getElementById('email'),
    password: document.getElementById('password'),
    loginBtn: document.getElementById('loginBtn'),
    logoutBtn: document.getElementById('logoutBtn'),
    gallery: document.getElementById('gallery'),
    auth: document.getElementById('auth')
  };

  let currentUser = null;          // cache for filters
  let all = [];                    // loaded rows

  async function refreshCurrentUser() {
    const { data } = await sb.auth.getUser();
    currentUser = data?.user || null;
  }

  async function refreshSession() {
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      await refreshCurrentUser();
      authEl.gallery.style.display = 'block';
      authEl.logoutBtn.style.display = 'inline-block';
      authEl.loginBtn.style.display = 'none';
      authEl.auth.querySelectorAll('input').forEach(i => i.style.display = 'none');
      loadAll();
    } else {
      currentUser = null;
      authEl.gallery.style.display = 'none';
      authEl.logoutBtn.style.display = 'none';
      authEl.loginBtn.style.display = 'inline-block';
      authEl.auth.querySelectorAll('input').forEach(i => i.style.display = 'inline-block');
    }
  }

  authEl.loginBtn.addEventListener('click', async () => {
    const { error } = await sb.auth.signInWithPassword({
      email: authEl.email.value.trim(),
      password: authEl.password.value
    });
    if (error) { alert(error.message); return; }
    refreshSession();
  });

  authEl.logoutBtn.addEventListener('click', async () => {
    await sb.auth.signOut();
    refreshSession();
  });

  // Gallery refs
  const el = {
    file: document.getElementById('file'),
    tagsInput: document.getElementById('tagsInput'),
    descInput: document.getElementById('descInput'),
    uploadBtn: document.getElementById('uploadBtn'),
    filterInput: document.getElementById('filterInput'),
    clearBtn: document.getElementById('clearBtn'),
    grid: document.getElementById('grid'),
    mineOnly: document.getElementById('mineOnly'),
    userIdFilter: document.getElementById('userIdFilter')
  };

  function normalizeTags(str) {
    const arr = (str || '')
      .split(/[,\s]+/).map(t => t.trim().toLowerCase()).filter(Boolean);
    return Array.from(new Set(arr));
  }

  function render(items) {
    el.grid.innerHTML = items.map(it => `
      <article class="card">
        <a href="${it.url}" target="_blank" rel="noopener">
          <img src="${it.url}" alt="" loading="lazy">
        </a>
        <div class="tags">${(it.tags || []).map(t => `<span class="tag">#${t}</span>`).join('')}</div>
        ${it.description ? `<p style="font-size:13px;margin-top:4px;">${it.description}</p>` : ""}
        ${it.user_id ? `<p style="margin:6px 0 0; font-size:12px; opacity:.7;">uploader: ${it.user_id.slice(0,8)}…</p>` : ""}
        <button class="edit-btn" data-id="${it.id}" style="margin-top:6px;">Edit</button>
      </article>
    `).join('');
  }

  function applyFilter() {
    const tagTerms = normalizeTags(el.filterInput.value);
    const mine = !!el.mineOnly?.checked;
    const userIdTerm = (el.userIdFilter?.value || '').trim().toLowerCase();

    let items = all.slice();

    if (tagTerms.length) {
      items = items.filter(it => tagTerms.every(t => (it.tags || []).includes(t)));
    }
    if (mine && currentUser) {
      items = items.filter(it => it.user_id === currentUser.id);
    }
    if (userIdTerm) {
      items = items.filter(it => (it.user_id || '').toLowerCase().includes(userIdTerm));
    }

    render(items);
  }

  async function loadAll() {
    const { data, error } = await sb.from('photos').select('*').order('created_at', { ascending: false });
    if (error) { console.error(error); return; }
    all = data || [];
    applyFilter();
  }

  // Listeners
  el.filterInput.addEventListener('input', applyFilter);
  el.clearBtn.addEventListener('click', () => { el.filterInput.value = ''; applyFilter(); });
  el.mineOnly.addEventListener('change', applyFilter);
  el.userIdFilter.addEventListener('input', applyFilter);

  el.uploadBtn.addEventListener('click', async () => {
    const file = el.file.files?.[0];
    if (!file) return alert('Pick an image first');
    const tags = normalizeTags(el.tagsInput.value);
    const desc = el.descInput.value || null;

    const { data: userData } = await sb.auth.getUser();
    const user = userData?.user;
    if (!user) return alert('Please sign in first.');

    const ext = file.name.split('.').pop()?.toLowerCase() || 'jpg';
    const key = `${user.id}/${crypto.randomUUID()}.${ext}`;
    const { error: upErr } = await sb.storage.from(BUCKET).upload(key, file, { upsert: false });
    if (upErr) { console.error(upErr); return alert('Upload error: ' + upErr.message); }

    const pub = sb.storage.from(BUCKET).getPublicUrl(key);
    const url = pub?.data?.publicUrl;
    if (!url) return alert('No public URL returned (check storage policy).');

    const { data: row, error: insErr } = await sb
      .from('photos')
      .insert({ url, tags, description: desc, user_id: user.id })
      .select()
      .single();
    if (insErr) { console.error(insErr); return alert('Save error: ' + insErr.message); }

    el.file.value = '';
    el.tagsInput.value = '';
    el.descInput.value = '';
    all.unshift(row);
    applyFilter();
  });

  // Edit tags + description
  el.grid.addEventListener('click', async (e) => {
    const btn = e.target.closest('.edit-btn');
    if (!btn) return;

    const { data: userData } = await sb.auth.getUser();
    const user = userData?.user;
    if (!user) { alert('Please sign in first.'); return; }

    const id = btn.dataset.id;
    const item = all.find(x => x.id === id);
    if (!id || !item) { alert('Could not find this photo'); return; }

    const tagsInput = prompt('Tags (comma/space separated):', (item.tags||[]).join(' '));
    if (tagsInput === null) return;
    const newTags = normalizeTags(tagsInput);

    const descInput = prompt('Description:', item.description || '');
    if (descInput === null) return;

    const { data: updated, error } = await sb
      .from('photos')
      .update({ tags: newTags, description: descInput })
      .eq('id', id)
      .eq('user_id', user.id)
      .select()
      .maybeSingle();

    if (error || !updated) { console.error(error); alert('Update failed'); return; }

    const idx = all.findIndex(x => x.id === id);
    if (idx !== -1) all[idx] = updated;
    applyFilter();
  });

  // boot
  refreshSession();
</script>

<script>
(async () => {
  console.log("Client URL:", SUPABASE_URL);
  const buckets = await sb.storage.listBuckets();
  console.log("listBuckets():", buckets);

  const list = await sb.storage.from('photos').list('', { limit: 5 });
  console.log("list('photos'):", list);
})();
</script>